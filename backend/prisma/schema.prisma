// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum UserRole {
  SUPER_USER
  ADMINISTRATOR
  DCS
  MINISTRY_COORDINATOR
  CLASS_SHEPHERD
  MEMBER
}

enum EventStatus {
  UPCOMING
  ONGOING
  COMPLETED
  CANCELLED
}

enum CheckInMethod {
  QR_CODE
  MANUAL
}

enum RegistrationType {
  MEMBER
  NON_MEMBER
  COUPLE
}

enum PaymentStatus {
  PENDING
  PAID
  REFUNDED
  CANCELLED
}

model User {
  id           String   @id @default(uuid())
  email        String?  @unique
  phone        String?  @unique
  passwordHash String
  role         UserRole @default(MEMBER)
  isActive     Boolean  @default(true)
  // Class Shepherd specific fields - which encounter class they shepherd
  // Note: Class Shepherds shepherd a DIFFERENT class than their own
  // e.g., A person from ME Class 18 can be assigned to shepherd ME Class 101
  // The shepherdEncounterType and shepherdClassNumber store the class they shepherd, NOT their own class
  shepherdEncounterType  String? // e.g., "ME", "SE", "SPE", "YE" - the class they shepherd
  shepherdClassNumber    Int?    // e.g., 101 for ME Class 101 - the class they shepherd
  ministry               String? // For MINISTRY_COORDINATOR
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  member       Member?
  sessions     Session[]
  eventClassShepherds EventClassShepherd[]

  @@index([email])
  @@index([phone])
  @@index([role])
  @@index([shepherdEncounterType, shepherdClassNumber])
}

model Session {
  id           String   @id @default(uuid())
  userId       String
  refreshToken String   @unique
  expiresAt    DateTime
  createdAt    DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([refreshToken])
}

model Member {
  id              String   @id @default(uuid())
  userId          String   @unique
  firstName       String
  lastName        String
  middleName      String?
  suffix          String?
  nickname        String?
  communityId     String   @unique
  city            String
  encounterType   String
  classNumber     Int
  apostolate      String?
  ministry        String?
  serviceArea      String?
  photoUrl        String? // BunnyCDN URL
  qrCodeUrl       String? // BunnyCDN URL
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  user            User            @relation(fields: [userId], references: [id], onDelete: Cascade)
  attendances     Attendance[]
  registrations   EventRegistration[]

  @@index([communityId])
  @@index([city])
  @@index([encounterType])
}

model Event {
  id                String        @id @default(uuid())
  title             String
  eventType         String
  category          String
  description       String?
  startDate         DateTime
  endDate           DateTime
  startTime         String?
  endTime           String?
  location          String
  venue             String?
  status            EventStatus  @default(UPCOMING)
  cancellationReason String? // Reason for cancellation (optional)
  hasRegistration   Boolean      @default(false)
  registrationFee   Decimal?
  maxParticipants   Int?
  qrCodeUrl         String? // BunnyCDN URL
  // Encounter Event fields - for Encounter type events (ME, SE, SPE, FE, YE)
  encounterType     String? // e.g., "ME", "SE", "SPE", "FE", "YE"
  classNumber       Int? // e.g., 18 for ME Class 18, 101 for SE Class 101
  // Recurring event fields
  isRecurring       Boolean      @default(false)
  recurrencePattern String? // daily, weekly, monthly
  recurrenceDays    String[] // For weekly: ["monday", "wednesday"]
  recurrenceInterval Int? // Every N days/weeks/months
  monthlyType       String? // dayOfMonth, dayOfWeek
  monthlyDayOfMonth Int?
  monthlyWeekOfMonth Int?
  monthlyDayOfWeek   String?
  createdAt         DateTime     @default(now())
  updatedAt         DateTime     @updatedAt

  attendances       Attendance[]
  registrations     EventRegistration[]
  account           EventAccount?
  classShepherds    EventClassShepherd[]

  @@index([status])
  @@index([encounterType, classNumber])
  @@index([startDate])
  @@index([eventType])
}

model Attendance {
  id          String        @id @default(uuid())
  memberId    String
  eventId     String
  checkInTime DateTime      @default(now())
  method      CheckInMethod @default(MANUAL)
  createdAt   DateTime      @default(now())

  member      Member        @relation(fields: [memberId], references: [id], onDelete: Cascade)
  event       Event         @relation(fields: [eventId], references: [id], onDelete: Cascade)

  @@unique([memberId, eventId])
  @@index([eventId])
  @@index([memberId])
  @@index([checkInTime])
}

model EventRegistration {
  id              String        @id @default(uuid())
  eventId         String
  memberId        String?
  registrationType RegistrationType
  firstName       String
  lastName        String
  middleName      String?
  email           String?
  phone           String?
  spouseFirstName String?
  spouseLastName  String?
  spouseMiddleName String?
  // Couple registration linking
  coupleRegistrationId String?  // Links registrations together for ME events
  coupleRole      String?       // HUSBAND, WIFE, PERSON1, PERSON2
  // Additional fields
  specialRequirements String?   // Special requirements/notes
  emergencyContact    String?    // Emergency contact info (JSON string or text)
  memberCommunityId  String?    // Community ID (for non-members who get assigned one)
  roomAssignment  String?
  paymentStatus   PaymentStatus @default(PENDING)
  paymentAmount   Decimal?
  paymentReference String?
  notes           String?
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt

  member          Member?       @relation(fields: [memberId], references: [id], onDelete: SetNull)
  event           Event         @relation(fields: [eventId], references: [id], onDelete: Cascade)

  @@index([eventId])
  @@index([memberId])
  @@index([registrationType])
  @@index([paymentStatus])
  @@index([coupleRegistrationId])
}

model EventAccount {
  id          String   @id @default(uuid())
  eventId     String   @unique
  isClosed   Boolean  @default(false)
  closedAt    DateTime?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  event       Event         @relation(fields: [eventId], references: [id], onDelete: Cascade)
  incomeEntries IncomeEntry[]
  expenseEntries ExpenseEntry[]

  @@index([eventId])
  @@index([isClosed])
}

model IncomeEntry {
  id          String   @id @default(uuid())
  accountId   String
  description String
  amount      Decimal
  source      String?
  receivedAt  DateTime @default(now())
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  account     EventAccount @relation(fields: [accountId], references: [id], onDelete: Cascade)

  @@index([accountId])
  @@index([receivedAt])
}

model ExpenseEntry {
  id          String   @id @default(uuid())
  accountId   String
  description String
  amount      Decimal
  category    String?
  paidAt      DateTime @default(now())
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  account     EventAccount @relation(fields: [accountId], references: [id], onDelete: Cascade)

  @@index([accountId])
  @@index([paidAt])
}

// Event Class Shepherd Assignment
// Links Class Shepherds to specific Encounter Events and their classes
// Allows up to 4 shepherds per encounter class per event
model EventClassShepherd {
  id              String   @id @default(uuid())
  eventId         String
  userId          String   // User with CLASS_SHEPHERD role
  encounterType   String   // e.g., "ME", "SE", "SPE", "YE"
  classNumber     Int      // e.g., 18 for ME Class 18
  assignedBy      String   // User ID who assigned this shepherd
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  event           Event    @relation(fields: [eventId], references: [id], onDelete: Cascade)
  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([eventId, userId, encounterType, classNumber]) // Prevent duplicate assignments
  @@index([eventId])
  @@index([userId])
  @@index([encounterType, classNumber])
}

